---
title: "DSI_Data_Challenge_5"
author: "Dingxin Lu"
date: "11/29/2021"
output: 
  html_document:
   df_print: paged
   toc: true 
   toc_depth: 2  
   number_sections: false
   toc_float:
     collapsed: true
     smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

[My Github link] https://github.com/sydneydlu98/DSI_Data_Challenge_5

# Loading/Cleaning Data and Exploratory Analysis

In this Data Challenge, we will be clustering foods from the nndb_flat dataset provided on Canvas. To load/clean the data as well as perform some exploratory analysis:

1. Read in the data

```{r, message=FALSE}
## load all the packages
library(readr)
library(dplyr)
library(GGally)
library(tidyverse)
library(plotly)
library(ggplot2)

## read in data
data <- read_csv("nndb_flat.csv")
```

2. We will be dealing with only data that falls under the food groups of Vegetables and Vegetable Products, Beef Products, and Sweets. Filter the data to contain only these food groups.

```{r}
## filter the data to only contain food groups of Vegetables and Vegetable Products, Beef Products, and Sweets
object <-
  c("Sweets", "Beef Products", "Vegetables and Vegetable Products")

clean_data <- data %>%
  subset(FoodGroup %in% object)
```

3. Select only the variables from Energy_kcal to Zinc_mg

```{r}
var <- clean_data %>%
  select(Energy_kcal:Zinc_mg)
```

4. Examine the correlation among the variables using GGally::ggcorr. Which variables have a high correlation?

```{r}
GGally::ggcorr(
  var,
  size = 3.2,
  label = TRUE,
  label_size = 2.7,
  hjust = .9,
  layout.exp = 2
) 
```

If the coefficient value lies between ± 0.50 and ± 1, then it is said to be a strong correlation. If the value is near ± 1, then it said to be a perfect correlation: as one variable increases, the other variable tends to also increase (if positive) or decrease (if negative). 

We can see from the plot, we do not have any high negative correlation, but we do have many high positive correlation. Such as the correlation coefficient between Folate_mcg and Thiamin_mg is 1, which is perfect positive correlation, and others like Protein_g and Zinc_mg has a correlation coefficient of 0.9 which is considered high correlation.

# Performing PCA

Steps for performing the PCA on the data:

1. Perform PCA on the data. Don’t forget to scale the data (if it is appropriate for this application)!
```{r}
data_scaled <- scale(var)

pca_data <- prcomp(data_scaled, 
                   center = FALSE, 
                   scale. = FALSE)

summary(pca_data)
```

2. Makat1e a plot showing the cumulative proportion of the variation explained by each PC with cumulative variation explained on the y-axis and PC on the x-axis.

```{r}
var_explainded <- summary(pca_data)$importance[2, ]
cumulative <- cumsum(var_explainded)

var_explained_df <- data.frame(PC = 1:23,
                               var_explainded = var_explainded,
                               cum_var_explained = cumulative)

var_explained_df

var_explained_df %>%
  ggplot(aes(x = PC, y = cum_var_explained, group = 1)) +
  geom_point() +
  geom_line(lwd = 1) +
  labs(title = "Scree Plot: PCA",
       y = 'Cumulative Variation Explained',
       x = 'PC') +
  ggtitle("Plot of cumulative proportion of the variation explained by each PC") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  # add line for better visualization
  geom_vline(xintercept = 3,
             linetype = 2,
             lwd = 1,
             col = "red") 
```

3. We will look at the first 3 PCs which explain about 60% of the variation in the data. Note that you may want to look at more depending on what your application is. Make 3 separate plots for the loadings for the first 3 PCs for all of the variables, ordered by the absolute value of the magnitude of the loadings.

```{r}
pca_loadings <- as.data.frame(pca_data$rotation) %>%
  dplyr::select(PC1, PC2, PC3) %>%
  mutate(variable = rownames(pca_data$rotation))


pc1 <- ggplot(pca_loadings, aes(x = variable,
                                y = abs(PC1))) +
  geom_bar(stat = 'identity', fill = "#FF6666") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC1 for all of the variables") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc1

pc2 <- ggplot(pca_loadings, aes(x = variable,
                                y = abs(PC2))) +
  geom_bar(stat = 'identity', fill = "darkgreen") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC2 for all of the variables") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc2

pc3 <- ggplot(pca_loadings, aes(x = variable,
                                y = abs(PC3))) +
  geom_bar(stat = 'identity', fill = "blue") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC3 for all of the variables") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc3
```

4. Make 3 plots of the scores on the PCs colored by food group. Plot the below scores. Make the plots interactive with plotly so you can identify the food description of any outliers.

```{r}
pca_scores <- as.data.frame(pca_data$x)

pca_scores <- pca_scores %>%
  mutate(FoodGroup = clean_data$FoodGroup) %>%
  mutate(description = clean_data$ShortDescrip)

pca_scores
```

* 1. PC1 versus PC2

```{r}
plot1 <- ggplot(pca_scores,
                aes(
                  x = PC1,
                  y = PC2,
                  col = FoodGroup,
                  label = description
                )) +
  geom_point() +
  ggtitle("PC1 versus PC2") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))
  
ggplotly(plot1)
```

* 2. PC1 versus PC3

```{r}
plot2 <- ggplot(pca_scores, aes(x = PC1,
                                y = PC3,
                                col = FoodGroup,
                                label = description)) +
  geom_point() +
  ggtitle("PC1 versus PC3") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))

ggplotly(plot2)
```

* 3. PC2 versus PC3

```{r}
plot3 <- ggplot(pca_scores, aes(x = PC2, 
                       y = PC3, 
                       col = FoodGroup,
                       label = description)) +
  geom_point() +
  ggtitle("PC2 versus PC3") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))

ggplotly(plot3)
```

# Identify Outlier and Performing PCA Again

1. There is a major outlier on the plots above – which food is the outlier? Remove the outlier from your data.

**The major outlier on the plots above is yeast extract spread from the food group vegetable and vegatable products.**

Then we remove this outlier.

```{r}
## remove the outlier I identified above
complete_data <- clean_data %>%
  filter(ShortDescrip != "YEAST EXTRACT SPREAD")
```

2. Perform PCA again on the dataset without the outlier (steps 1-4 in the Performing PCA section above) and look at the loadings of the first 3 PCs. Have these changed? Investigate and comment on what could have caused any changes.

```{r}
var_new <- complete_data %>%
  select(Energy_kcal:Zinc_mg)

data_scaled_new <- scale(var_new)

pca_data_new <- prcomp(data_scaled_new,
                       center = FALSE,
                       scale. = FALSE)

summary(pca_data_new)

var_explainded_new <- summary(pca_data_new)$importance[2,]
cumulative_new <- cumsum(var_explainded_new)

var_explained_df_new <- data.frame(PC = 1:23,
                                   var_explainded = var_explainded_new, 
                                   cum_var_explained = cumulative_new)

var_explained_df_new

var_explained_df_new %>%
  ggplot(aes(x = PC, y = cum_var_explained, group = 1)) +
  geom_point() +
  geom_line(lwd = 1) +
  labs(title = "Scree Plot: PCA",
       y = 'Cumulative Variation Explained',
       x = 'PC') +
  ggtitle("Plot of cumulative proportion of the variation explained by each PC \n (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  # add line for better visualization
  geom_vline(
    xintercept = 3,
    linetype = 2,
    lwd = 1,
    col = "red"
  )

pca_loadings_new <- as.data.frame(pca_data_new$rotation) %>%
  dplyr::select(PC1, PC2, PC3) %>%
  mutate(variable = rownames(pca_data_new$rotation))


pc1_new <- ggplot(pca_loadings_new, aes(x = variable,
                                y = abs(PC1))) +
  geom_bar(stat = 'identity', fill = "#FF6666") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC1 for all of the variables \n (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc1_new

pc2_new <- ggplot(pca_loadings_new, aes(x = variable,
                                y = abs(PC2))) +
  geom_bar(stat = 'identity', fill = "darkgreen") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC2 for all of the variables \n (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc2_new

pc3_new <- ggplot(pca_loadings_new, aes(x = variable,
                                y = abs(PC3))) +
  geom_bar(stat = 'identity', fill = "blue") +
  theme(axis.text.x = element_text(
    angle = 50,
    hjust = 1,
    size = 13
  )) +
  ggtitle("Plot for the loadings of PC3 for all of the variables \n (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  labs(y = "Loadings", x = "Variables")

pc3_new

pca_scores_new <- as.data.frame(pca_data_new$x)

pca_scores_new <- pca_scores_new %>%
  mutate(FoodGroup = complete_data$FoodGroup) %>%
  mutate(description = complete_data$ShortDescrip)

pca_scores_new

plot1_new <- ggplot(pca_scores_new,
                    aes(
                      x = PC1,
                      y = PC2,
                      col = FoodGroup,
                      label = description
                    )) +
  geom_point() +
  ggtitle("PC1 versus PC2 (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))

ggplotly(plot1_new)

plot2_new <- ggplot(pca_scores_new,
                    aes(
                      x = PC1,
                      y = PC3,
                      col = FoodGroup,
                      label = description
                    )) +
  geom_point() +
  ggtitle("PC1 versus PC3 (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))

ggplotly(plot2_new)

plot3_new <- ggplot(pca_scores_new,
                    aes(
                      x = PC2,
                      y = PC3,
                      col = FoodGroup,
                      label = description
                    )) +
  geom_point() +
  ggtitle("PC2 versus PC3 (without outlier)") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))

ggplotly(plot3_new)
```

3. Describe what you see in the plots of the scores and interpret this in conjunction with the loadings that you observed for the PCs.


